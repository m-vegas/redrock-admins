<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Приватный чат Red-Rock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Ваши стили остаются без изменений */
        /* ... */
    </style>
</head>
<body>
    <!-- HTML-структура остается без изменений -->
    <!-- ... -->

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // Элементы DOM (остается без изменений)
        const generatedKeyInput = document.getElementById('generatedKey');
        const copyKeyBtn = document.getElementById('copyKeyBtn');
        // ... остальные элементы

        // Переменные состояния
        let peer = null;
        let chatChannel = null;
        let currentKey = generateKey();
        generatedKeyInput.value = currentKey;

        // Генерация ключа (без изменений)
        function generateKey() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Убраны сложные символы
            let result = '';
            for (let i = 0; i < 8; i++) { // Укороченный ключ
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return 'RR-' + result; // Добавляем префикс
        }

        // Инициализация PeerJS с исправлениями
        function initializePeerJS() {
            // Указываем свой сервер PeerJS (или используем облачный)
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 3
            });

            peer.on('open', (id) => {
                console.log('Мой ID:', id);
                updateStatus('Готов к подключению', false);
            });

            peer.on('connection', (conn) => {
                console.log('Входящее соединение от:', conn.peer);
                if (chatChannel && chatChannel.open) {
                    conn.close();
                    return;
                }
                setupConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('PeerJS ошибка:', err);
                updateStatus('Ошибка: ' + err.message, true);
                
                // Автоматический реконнект
                if (err.type === 'disconnected') {
                    setTimeout(() => peer.reconnect(), 2000);
                }
            });
        }

        // Улучшенная функция подключения
        function connectToPeer() {
            const friendKey = friendKeyInput.value.trim();
            if (!friendKey) {
                alert('Введите ключ собеседника');
                return;
            }

            if (!peer || peer.disconnected) {
                initializePeerJS();
            }

            // Ждем инициализации peer
            const checkReady = setInterval(() => {
                if (peer && peer.id) {
                    clearInterval(checkReady);
                    
                    const otherPeerId = 'redrock-' + hashCode(friendKey);
                    updateStatus(`Подключение к ${otherPeerId}...`, false);
                    
                    // Устанавливаем соединение с таймаутом
                    const conn = peer.connect(otherPeerId, {
                        reliable: true,
                        serialization: 'none',
                        metadata: { key: currentKey }
                    });

                    const timeout = setTimeout(() => {
                        if (!conn.open) {
                            conn.close();
                            updateStatus('Таймаут подключения', true);
                        }
                    }, 10000);

                    setupConnection(conn);
                }
            }, 100);
        }

        // Остальные функции без изменений
        function setupConnection(conn) {
            chatChannel = conn;
            
            conn.on('open', () => {
                console.log('Соединение установлено!');
                updateStatus('Чат активен', false);
                chatSection.style.display = 'block';
            });
            
            // ... остальные обработчики
        }

        // Хэш-функция с улучшениями
        function hashCode(str) {
            return str.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0).toString(36).replace('-', '');
        }

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            initializePeerJS();
            
            // Автоматическая перезагрузка при проблемах
            setTimeout(() => {
                if (!peer || !peer.id) {
                    window.location.reload();
                }
            }, 5000);
        });
    </script>
</body>
</html>
